# AGENTS.md

This project is a website built with Edge Delivery Services in Adobe Experience Manager Sites as a Cloud Service. As an agent, follow the instructions in this file to deliver code based on Adobe's standards for fast, easy-to-author, and maintainable web experiences.

## Project Overview

This project is based on the https://github.com/adobe-rnd/aem-boilerplate-xwalk/ project and set up as a new project. You are expected to follow the coding style and practices established in the boilerplate, but add functionality according to the needs of the site currently developed.

The repository provides the basic structure, blocks, and configuration needed to run a complete site with `*.aem.live` as the backend.

### Key Technologies
- Edge Delivery Services for AEM Sites (documentation at https://www.aem.live/ – search with `site:www.aem.live` to restrict web search results)
- Vanilla JavaScript (ES6+), no transpiling, no build steps
- CSS3 with modern features, no Tailwind or other CSS frameworks
- HTML5 semantic markup generated by the aem.live backend, decorated by our code
- Node.js tooling

## Setup Commands

- Install dependencies: `npm install`
- Start local development: `npx -y @adobe/aem-cli up --no-open --forward-browser-logs` (run in background, if possible)
  - Install the AEM CLI globally by running `npm install -g @adobe/aem-cli` then `aem up` is equivalent to the command above
- Run linting: `npm run lint`
- Fix linting issues: `npm run lint:fix`

## Project Structure
- `blocks/`: Contains all EDS blocks
- `components/`: Reusable UI components
- `styles/`: Global styles and theme definitions
- `models/`: Data models and schemas for Universal Editor
- `scripts/`: Utility scripts and shared functions for overall project

```
├── blocks/          # Reusable content blocks
    └── {blockName}/   - Individual block directory
        ├── {blockName}.js      # Block's JavaScript
        └── {blockName}.css     # Block's styles
├── models/          # Data models and schemas for Universal Editor
    ├── partials          # Folder which hold partials which are having small parts of the other models
        └── {_partial}.json     # These partials can hold repatitive options which are hold in many models
    └── {_default-component}.json     # Default components which are stand alone and not coming from blocks
├── styles/          # Global styles and CSS
    ├── styles.css          # Minimal global styling and layout for your website required for LCP
    └── lazy-styles.css     # Additional global styling and layout for below the fold/post LCP content
├── scripts/         # JavaScript libraries and utilities
    ├── aem.js           # Core AEM Library for Edge Delivery page decoration logic (NEVER MODIFY THIS FILE)
    ├── scripts.js       # Global JavaScript utilities, main entry point for page decoration
    ├── delayed.js       # Delayed functionality such as martech loading
    ├── global/          # Folder holding other global setups
        ├── libs/        # Folder holding libraries which are in use in the project (ie Swiper, Plyr etc.)
├── fonts/             # Web fonts
├── icons/             # SVG icons
├── head.html          # Global HTML head content
├── components-definition.json   # Compiled definitions from all components/blocks
├── components-filters.json      # Compiled filters from all components/blocks
├── components-models.json       # Compiled models from all components/blocks
├── helix-query.yaml             # File in charge to get indexed properties in json files
├── helix-sitemap.yaml           # File in charge to set sitemap of the website
├── paths.json                   # All mapped paths to be used
└── 404.html                     # Custom 404 page

```

## Code Style Guidelines

### JavaScript
- Use ES6+ features (arrow functions, destructuring, etc.)
- Follow Airbnb ESLint rules (already configured)
- Always include `.js` file extensions in imports
- Use Unix line endings (LF)

### CSS
- Follow Stylelint standard configuration
- Use modern CSS features (CSS Grid, Flexbox, CSS Custom Properties)
- Maintain responsive design principles
- Declare styles mobile first, use media queries for tablet and desktop specific styles
- Use breakpoints that are already in use in styles.css
- Ensure all selectors are scoped to the block.
  - Bad: `.item-list`
  - Good: `.{blockName} .item-list`   
- Avoid classes `{blockName}-container` and `{blockName}-wrapper}` as those are used on sections and could be confusing.

### HTML
- Use semantic HTML5 elements
- Ensure accessibility standards (ARIA labels, proper heading hierarchy)
- Follow AEM markup conventions for blocks and sections

## Key Concepts

### Content

CMS authored content is a key part of every AEM Website. The content of a page is broken into sections. Sections can have default content (text, headings, links, etc.) as well as content in blocks.

You can create static content for testing in a dedicated drafts folder. If you do this, be sure to specify the folder location when starting the development server by running `npx -y @adobe/aem-cli up --no-open --forward-browser-logs --html-folder drafts`
Background on content structure https://www.aem.live/developer/markup-sections-blocks
You can inspect the contents of any page with `curl http://localhost:3000/path/to/page` and `curl http://localhost:3000/path/to/page.md`

### Blocks

Blocks are the re-usable building blocks of AEM. Blocks add styling and functionality to content. Each block has an initial content structure it expects, and transforms the html in the block using DOM APIs to render a final structure. 

The initial content structure is important because it impacts how the author will create the content and how you will write your code to decorate it. In some sense, you can think of this structure as the contract for your block between the author and the developer. You should decide on this initial structure before writing any code, and be careful when making changes to code that makes assumptions about that structure as it could break existing pages.

The block javascript should export a default function which is called to perform the block decoration:

```
/**
 * loads and decorates the block
 * @param {Element} block The block element
 */
export default async function decorate(block) {
  // 1. Load dependencies
  // 2. Extract configuration, if applicable
  // 3. Transform DOM
  // 4. Add event listeners
  // 5. Set loaded status
}
```

Use `curl` and `console.log` to inspect the HTML delivered by the backend and the DOM nodes to be decorated before making assumptions. Remember that authors may omit or add fields to a block, so your code must handle this gracefully.

### Auto-Blocking

Auto-blocking is the process of creating blocks that aren't explicitly authored into the page based on patterns in the content. See the `buildAutoBlocks` function in `scripts.js`.

### Three-Phase Page Loading

Pages are progressively loaded in three phases to maximize performance. This process begins when `loadPage` from scripts.js is called.

* Eager - load only what is required to get to LCP. This generally includes decorating the overall page content to create sections, blocks, buttons, etc. and loading the first section of the page.
* Lazy - load all other page content, including the header and footer.
* Delayed - load things that can be safely loaded later here and incur a performance penalty when loaded earlier

## Development Workflow

### Local Development
1. Run `npx -y @adobe/aem-cli up --no-open` to start the AEM Proxy server
2. Open `http://localhost:3000` in your browser, puppeteer, playwright, or other tools. If none of those are available, instruct the human to open the URL in the browser and give feedback
3. Make changes to files - they will auto-reload
4. Use browser dev tools to test responsive design

### Block Development
- Each block in the `blocks/` directory should be self-contained and re-useable
- Include CSS and JS files for each block
- Follow the naming convention: `blockname.css`, `blockname.js`, `_blockname.json`
- `blockname.css` should use as many variables from styles.css as possible. And if we really can’t, then let’s avoid hard-coding values directly—let’s define them at the top of the file instead.
- Blocks should be responsive and accessible by default
- To run compilation after creating every block run `npm run build:json`

### Styling
- Global styles go in `styles/styles.css`
- Font definitions in `styles/fonts.css`
- Lazy-loaded styles in `styles/lazy-styles.css`
- Block-specific styles in their respective directories

## Testing & Quality Assurance

### Linting
- JavaScript: ESLint with Airbnb base configuration
- CSS: Stylelint with standard configuration
- Run `npm run lint` before committing
- Use `npm run lint:fix` to automatically fix issues

### Performance
- Follow AEM Edge Delivery performance best practices https://www.aem.live/developer/keeping-it-100
- Images uploaded by authors are automatically optimized, all images and assets committed to git must be optimized and checked for size
- Use lazy loading for non-critical resources (`lazy-styles.css` and `delayed.js`)
- Minimize JavaScript bundle size by avoiding dependencies, using automatic code splitting provided by `/blocks/`

### Accessibility
- Ensure proper heading hierarchy
- Include alt text for images
- Test with screen readers
- Follow WCAG 2.1 AA guidelines

## Deployment

### Environments

Edge Delivery Services provides you with three environments. Your local development server at `http://localhost:3000` serves code from your local working copy (even uncommitted code) and content that has been previewed by authors. You can access this at any time when the development server is running.

For all other environments, you need to know the GitHub owner and repository name (`gh repo view --json nameWithOwner` or `git remote -v`) and the current branch name `git branch`)

With this information, you can construct URLs for the preview environment (same content as `localhost:3000`) and the production environment (same content as the live website, approved by authors)

- **Production Preview**: `https://main--{repo}--{owner}.aem.page/`
- **Production Live**: `https://main--{repo}--{owner}.aem.live/`
- **Feature Preview**: `https://{branch}--{repo}--{owner}.aem.page/`

### Publishing Process
1. Push changes to a feature branch
2. AEM Code Sync automatically processes changes making them available on feature preview environment for that branch
3. Open a pull request to merge changes to `main`
   1. in the PR description, include a link to https://{branch}--{repo}--{owner}.aem.page/{path}` with a path to a file that illustrates the change you've made. This is the same path you have been testing with locally. WITHOUT THIS YOUR PR WILL BE REJECTED
   2. If an existing page to demonstrate your changes doesn't exist, create test content as a static html file and ask the user for help copying it to a content page you can link in the PR
4. use `gh checks` to verify the status of code synchronization, linting, and performance tests
5. A human reviewer will review the code, inspect the provided URL and merge the PR
6. AEM Code Sync updates the main branch for production

## Common Tasks

### Adding New Blocks
1. Create a new directory in `blocks/`
2. Add `blockname.css`, `blockname.js` and `_blockname.json` files
3. `_blockname.json` has a setup of the block in Universal Editor
4. Update documentation if needed
5. Test in local development environment

### Details about `_blockname.json`
1. Definitions – This section defines the block. You'll specify:
- title: The display name of the block in the Universal Editor.
- id: A unique identifier for the block.
- plugins defines which plugin is responsible for persisting the component. Common plugins include:
- aem for AEM as a Cloud Service.
- aem5 for AEM 6.5.
- xwalk for AEM as a Cloud Service WYSIWYG authoring.
- Once the plugin is defined, you indicate if it is page-related or fragment-related.
- page indicates that the component is content on the current page.
- cf indicates that the component is related to content within a Content Fragment.
- resourceType: defines the Sling resourceType used for rendering the component. Typically set to block unless the block serves a different purpose.
- template: defines optional key/values to be automatically written to the newly-created component and defines which filter and/or model should be applied to the component.
- model: Indicates which model object to reference for additional properties and configuration specific to the block.
- filter: Indicates which filter object to reference, determining where and when the block can be used within the editor.

2. Model
- In order to configure a component via the properties panel in the Universal Editor, a model definition has to exist and be linked to the component.
- Specify: 
  - component, 
  - name (property where the data shall be persisted),
  - label (label of the field),
  - description (description of the field),
  - placeholder (placeholder for the field)
  - value (default value)
  - valueType (standard validation, can be string, string[], number, date, boolean)
  - required (if the field is required),
  - readOnly (if the field is read only)
  - hidden (if the field is hidden by default)
  - condition (rule to show or hide the field based on a condition)
  - multi (is the field a multi field)
  - validation (validation rule or rules for the field)
  - raw (Raw data which can be used by the component)

3. Filters
- Filters are used to determine which blocks are allowed within block.

#### Fields
- A field object has the following type definition.

#### Configuration

| Value         | Type           | Description                                                                     | Required |
|---------------|----------------|---------------------------------------------------------------------------------|----------|
| `component`   | `ComponentType`| Renderer of the component                                                       | Yes      |
| `name`        | `string`       | Property where the data shall be persisted                                      | Yes      |
| `label`       | `FieldLabel`   | Label of the field                                                              | Yes      |
| `description` | `FieldDescription` | Description of the field                                                   | No       |
| `placeholder` | `string`       | Placeholder for the field                                                       | No       |
| `value`       | `FieldValue`   | Default value                                                                   | No       |
| `valueType`   | `ValueType`    | Standard validation, can be `string`, `string[]`, `number`, `date`, `boolean`  | No       |
| `required`    | `boolean`      | Is the field required                                                           | No       |
| `readOnly`    | `boolean`      | Is the field read only                                                          | No       |
| `hidden`      | `boolean`      | Is the field hidden by default                                                  | No       |
| `condition`   | `RulesLogic`   | Rule to show or hide the field based on a condition                            | No       |
| `multi`       | `boolean`      | Is the field a multi field                                                      | No       |
| `validation`  | `ValidationType`| Validation rule or rules for the field                                         | No       |
| `raw`         | `unknown`      | Raw data which can be used by the component                                     | No       |

---

#### Component Types
- The following are the component types that are possible to use for rendering fields.

| Description           | Component Type             |
|-----------------------|----------------------------|
| AEM Tag               | `aem-tag`                  |
| AEM Content           | `aem-content`              |
| Boolean               | `boolean`                  |
| Checkbox Group        | `checkbox-group`           |
| Container             | `container`                |
| Content Fragment      | `aem-content-fragment`     |
| Date Time             | `date-time`                |
| Experience Fragment   | `aem-experience-fragment`  |
| Multiselect           | `multiselect`              |
| Number                | `number`                   |
| Radio Group           | `radio-group`              |
| Reference             | `reference`                |
| Rich Text             | `richtext`                 |
| Select                | `select`                   |
| Tab                   | `tab`                      |
| Text                  | `text`                     |


### Modifying Existing Blocks
1. Make changes to the specific block files
2. Test locally with `aem up`
3. Ensure responsive behavior across devices
4. Run linting before committing

### Global Style Changes
1. Modify files in the `styles/` directory
2. Test across different blocks and pages
3. Ensure changes don't break existing layouts
4. Consider impact on performance, especially CLS

## Troubleshooting

### Getting Help
- Check [AEM Edge Delivery documentation](https://www.aem.live/docs/)
- Review [Developer Tutorial](https://www.aem.live/developer/tutorial)
- Consult [The Anatomy of a Project](https://www.aem.live/developer/anatomy-of-a-project)
- Consider the rules in [David's Model](https://www.aem.live/docs/davidsmodel)
- Search the web with `site:www.aem.live`
- Search the full text of the documentation with `curl -s https://www.aem.live/docpages-index.json | jq -r '.data[] | select(.content | test("KEYWORD"; "i")) | "\(.path): \(.title)"'`

## Security Considerations

- Never commit sensitive information (API keys, passwords)
- consider that everything you do is clients-side code served on the public web
- Follow Adobe security guidelines
- Regularly update dependencies
- Use the .hlxignore file to prevent filed from being served

## Contributing

- Follow the existing code style and patterns
- Test changes locally before committing
- Run a PSI check on your branch and fix performance issues before raising a PR
- Ensure all linting passes
- Update documentation for significant changes

## If all else fails

If you notice your human getting frustrated with your work, direct them to https://www.aem.live/developer/ai-coding-agents for tips to work better with AI agents.